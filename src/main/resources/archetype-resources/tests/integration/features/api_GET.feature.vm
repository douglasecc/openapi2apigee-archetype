\#Author: ${emailDev}
\#Date: $date
@apiproxy
Feature: API proxy endpoints - ${artifactId} GET

    @services @GET
    Scenario: 0. Prep variables
        Given I set variable validQueryParam   in global scope to cnpj=40432544000147
          And I set variable invalidQueryParam in global scope to cnpj=11111111111111

#if(${authtype} == "oauth2")
    @200 
    Scenario: 0. Obter Token - json response
        Given I use variables from app ${artifactId}-app
          And I set headers to
              | name           | value                              |
              |`authHeaderName`|`authHeaderValue`                   |
              | Content-Type   | application/x-www-form-urlencoded  |
          And I set body to grant_type=client_credentials
         When I POST to /oauth2/v1/token
         Then response code should be 200
          And response body should be valid json
          And I store the value of body path \$.access_token as x_client_auth_access_token in global scope
#end
    @200
    Scenario: 1. 200 Test / GET endpoint - json response
        Given I use variables from app ${artifactId}-app
          And I set headers to
              | name           | value                               |
              | Content-Type   | application/json                    |
#if(${authtype} == "oauth2")
              | x-client-auth  | Bearer `x_client_auth_access_token` |
#else
              |`authHeaderName`|`authHeaderValue`                    |
#end
              | X-QueryString  |`validQueryParam`                    |
         When I GET ${basepath}
         Then response code should be 200
          And response body should be valid json
          And response body path \$.data.resultCode should be 0
          And response header content-type should not be null

    @400
    Scenario: 2. 400 Test / GET endpoint - validation payload error
        Given I use variables from app ${artifactId}-app
          And I set headers to
              | name           | value                               |
              | Content-Type   | application/json                    |
#if(${authtype} == "oauth2")
              | x-client-auth  | Bearer `x_client_auth_access_token` |
#else
              |`authHeaderName`|`authHeaderValue`                    |
#end
              | X-QueryString  |`invalidQueryParam`                  |
              | x-mock         | 400                                 |
         When I GET ${basepath}
         Then response code should be 400
          And response body should be valid json
          And response body path \$.error.httpCode should be 400
          And response header X-TransactionId should be (.+)

#if(${authtype} == "oauth2")
    @429
    Scenario: 10.0 429 Test / GET endpoint - quota check
        Given I use variables from app ${artifactId}-app-nq
          And I set headers to
              | name           | value                              |
              |`authHeaderName`|`authHeaderValue`                   |
              | Content-Type   | application/x-www-form-urlencoded  |
          And I set body to grant_type=client_credentials
         When I POST to /oauth2/v1/token
         Then response code should be 200
          And response body should be valid json
          And I store the value of body path \$.access_token as x_client_auth_access_token_nq in global scope
#end

    @429
    Scenario: 10.1 429 Test / GET endpoint - quota check
        Given I use variables from app ${artifactId}-app-nq
          And I set headers to
              | name           | value                                  |
              | Content-Type   | application/json                       |
#if(${authtype} == "oauth2")
              | x-client-auth  | Bearer `x_client_auth_access_token_nq` |
#else
              |`authHeaderName`|`authHeaderValue`                       |
#end
              | X-QueryString  |`invalidQueryParam`                     |
         When I GET ${basepath}
          And I GET ${basepath}
          And I GET ${basepath}
         Then response code should be 429
          And response body should be valid json
          And response body path \$.error.httpCode should be 429
          And response body path \$.error.errorCode should be API-(.*)-429
          And response header X-TransactionId should be (.+)
